pool:
  name: cyt-vs2019-eastus

parameters:
- name: testcase
  displayName: Test Case ID
  type: string
  default: 'C40493'

- name: environments
  displayName: Environment
  type: object
  default: [test,staging]

steps:
- ${{ each env in parameters.environments }}:
- script: |
   cd $(Build.BinariesDirectory)\
   dir
   python -m pip install -r requirements.txt
   python -m pytest -v -m ${{ parameters.testcase }} --self-contained-html --nunitxml=Reports/test-results.xml .\testCases\ --env="${{ env }}"
   
   echo "FETCH LOG FILE - DISPLAY CONTENT"
   cd $(Build.BinariesDirectory)\logs\
   type testlog.log
  displayName: 'Command Line Script'

- task: PublishTestResults@2
  displayName: 'Publish Results'
  inputs:
    testResultsFormat: NUnit
    searchFolder: '$(Build.BinariesDirectory)'
    testRunTitle: 'Py Result'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: test-automation'
  inputs:
    PathtoPublish: '$(Build.BinariesDirectory)/${{ parameters.testcase }}_results.zip'
    ArtifactName: 'test-automation'
